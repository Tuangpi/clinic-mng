var appointmentSearch=function(){let e=$("#appointmentSearchModal"),t=$("#appointmentsTable"),n=null;return{viewSearch:function(){null==n&&(n=t.DataTable({processing:!0,serverSide:!0,ajax:`${_url}`,columns:[{data:null,name:"actions",searchable:!1,orderable:!1},{data:"start_date",name:"start_date"},{data:"end_date",name:"end_date",render:function(e){return cms.formatDateTime(e)}},{data:"recurring",name:"recurring"},{data:"category",name:"category"},{data:"patient",name:"patient"},{data:"guest",name:"guest"},{data:"mobile_no",name:"mobile_no"},{data:"branch",name:"branch"},{data:"status",name:"status"}],order:[[1,"desc"]],createdRow:function(e,t,n){let a=$(e);a.find("td:eq(0)").addClass("text-center").html(`<div class="btn-group dropend">\n                        <a href="#" class="dropdown-toggle text-primary" data-bs-toggle="dropdown">\n                        <i class="fa fa-ellipsis-vertical"></i>\n                        </a>\n                        <ul class="dropdown-menu dropdown-menu-end">\n                            <li><button id="edit${t.id}" class="dropdown-item edit fs-11px" type="button">Edit</button></li>\n                        </ul>\n                    </div>`),a.find("td:eq(1)").html(`<a href="javascript:;" class='view'>${cms.formatDateTime(t.start_date)}</a>`)},drawCallback:function(){t.find(".edit").unbind("click").click((function(){_id=this.id.replace("edit",""),appointmentForm.viewForm()})),t.find(".view").unbind("click").click((function(){appointmentList.viewDay(moment(this.text).format("YYYY-MM-DD")),e.modal("hide")}))},initComplete:function(){$("#appointmentsTable_filter input").unbind(),$("#appointmentsTable_filter input").keyup((function(e){13==e.keyCode&&n.search(this.value).draw()}))}}));e.modal("show")}}}(),appointmentDetails=function(){let e,t=$("#appointmentDetailsModal"),n=t.find("#categoryIndicator"),a=t.find("#patient"),i=t.find("#mobileNo"),r=t.find("#category"),d=t.find("#scheduleDate"),o=t.find("#scheduleTime"),l=t.find("#prefix"),s=t.find("#details"),c=t.find("#status"),m=t.find("#addPatientToTheQueue"),p=t.find("#addToPatientRecords"),u=t.find("#edit"),f=t.find("#delete");return{init:function(){u.click((function(){t.modal("hide"),appointmentForm.viewForm()})),c.change((function(){const e=this.value;cms.put(`${_url}/${_id}/update-status/${e}`,null,(()=>{m.prop("disabled",4==e),toastr.success("Status has been updated.","Update Status"),appointmentList.reload()}))})),f.click((function(){cms.confirm("Delete appointment","Are you sure you want to delete this record?",(()=>{cms.delete(`${_url}/${_id}`,null,(()=>{toastr.success("Record has been deleted.","Delete appointment"),appointmentList.reload(),t.modal("hide")}))}))})),m.click((function(){!function(){let n={patient:e.patient_id,timeIn:cms.currentDateTime(!1),appointment:cms.convertToDateTime(appointmentList.getPatientAppointment(e.patient_id)),notes:""};cms.saveForm(0,n,`${_rootUrl}/queue`,(function(){t.modal("hide")}))}()})),p.click((function(){!function(){let t={firstName:e.first_name,lastName:e.last_name,mobileNo:e.mobile_no};cms.saveForm(0,t,`${_url}/${_id}/create-patient`,(function(){h()}))}()}))},viewDetails:h};function h(){cms.get(`${_url}/${_id}`,null,(function(u){const f=u.appointment;e=f,n.css("color","#"+f.appointment_category.hex_color),null==f.patient_id?(a.text(`${f.first_name} ${f.last_name}`),i.text(f.mobile_no),p.show(),m.hide()):(a.text(`${f.patient.first_name} ${f.patient.last_name} (${f.patient.code})`),i.text(f.patient.mobile_number),p.hide(),m.show()),r.text(f.appointment_category.description);const h=moment(f.start_date),g=moment(f.end_date);null==f.end_date?(d.text(`${h.format("dddd, LL")}`),o.text(`${h.format("h:mm a")}`)):(d.text(`${h.format("dddd, LL")}${h.isSame(g,"day")?"":` - ${g.format("dddd, LL")}`}`),o.text(`${h.format("h:mm a")} - ${g.format("h:mm a")}`)),l.text(f.prefix),s.text(f.details),c.val(f.appointment_status_id),m.prop("disabled",4==f.appointment_status_id),t.modal("show")}))}}(),appointmentForm=function(){let e,t,n=$("#appointmentFormModal"),a=$("#appointmentFormModalTitle"),i=$("#appointmentForm"),r=i.find("#guestFieldContainer"),d=i.find(".guest-field"),o=i.find(".guest-field-label"),l=i.find("#firstName"),s=i.find("#lastName"),c=i.find("#mobileNo"),m=i.find("#patient"),p=i.find("#prefix"),u=i.find("#details"),f=i.find("#startDate"),h=i.find("#endDate"),g=i.find("#recurring"),v=i.find("#recurringIntervalContainer"),_=i.find("#interval"),D=i.find("#recurringEndDate"),b=i.find("#recurringDOWContainer"),w=i.find("#dow"),k=i.find("#category"),y=i.find("#status"),C=i.find("#sendEmail"),T=i.find("#patientEmail"),x=$("#saveAppointment");return{init:function(){e=f.datetimepicker({format:"DD/MM/YYYY hh:mm A",keepOpen:!0,sideBySide:!0}),t=h.datetimepicker({format:"DD/MM/YYYY hh:mm A",keepOpen:!0,sideBySide:!0}),D.datepicker(),m.select2({placeholder:"Select Patient",dropdownParent:i,allowClear:!0}),g.select2({placeholder:"Does not repeat",dropdownParent:i,allowClear:!0}),k.select2({placeholder:"Select Category",dropdownParent:i}),y.select2({placeholder:"Select Status",dropdownParent:i}),w.select2({placeholder:"Select Day of Week",dropdownParent:i,closeOnSelect:!1}),m.change((function(){const e=""==this.value;if(d.prop("required",e),e)o.addClass("required"),r.slideDown();else{o.removeClass("required"),r.slideUp();const e=$(this).find("option:selected").data("email"),t=null!=e&&null!=e&&""!=e;C.prop("checked",t).prop("disabled",!t).trigger("change"),T.text(t?` ( ${e} )`:"")}})),C.change((function(){$(this).is(":checked")?y.val(2).prop("disabled",!0):y.val(1).prop("disabled",!1),y.trigger("change")})),g.change((function(){""==this.value?(v.slideUp(),b.slideUp(),_.prop("required",!1).val(""),D.prop("required",!1).val(""),w.val("").trigger("change")):(_.attr("required",!0),D.attr("required",!0),v.slideDown(),2==this.value?b.slideDown():b.slideUp())})),x.click((function(){!function(){if(i.parsley().validate()){let e={firstName:l.val(),lastName:s.val(),mobileNo:c.val(),patient:m.val(),prefix:p.val(),details:u.val(),startDate:cms.convertToDateTime(f.val()),endDate:cms.convertToDateTime(h.val()),category:k.val(),status:y.val(),recurring:g.val(),interval:_.val(),recurringEndDate:cms.convertToDateTime(D.val()),dow:w.val().join(","),sendEmail:C.is(":checked")?1:0};cms.saveForm(_id,e,_url,(function(){appointmentList.reload(),0==_id&&P()}))}}()})),n.on("hidden.bs.modal",(function(){P()}))},viewForm:function(r,d,o){0==_id?(null!=r&&null!=d&&(e.data("DateTimePicker").date(cms.formatDateTime(r)),t.data("DateTimePicker").date(cms.formatDateTime(d))),null!=o&&k.val(o).trigger("change"),a.text("Create Appointment"),n.modal("show")):(a.text("Edit Appointment"),cms.get(`${_url}/${_id}/edit`,null,(function(a){if(_isCurrentBranchAll){let e=['<option value="" disabled selected></option>'];for(let t=0;t<a.categories.length;t++){const n=a.categories[t];e.push(` <option value="${n.id}">${n.description}</option>`)}k.select2("destroy").html(e.join("")).select2({placeholder:"Select Category",dropdownParent:i})}!function(n){l.val(n.first_name),s.val(n.last_name),c.val(n.mobile_no),m.val(n.patient_id).trigger("change"),p.val(n.prefix),u.val(n.details),e.data("DateTimePicker").date(cms.formatDateTime(n.start_date)),t.data("DateTimePicker").date(cms.formatDateTime(n.end_date)),k.val(n.appointment_category_id).trigger("change"),null!=n.recurring_type_id&&(g.val(n.recurring_type_id).trigger("change"),_.val(n.recurring_interval),D.datepicker("setDate",cms.formatDate(n.recurring_end_date)),null!=n.recurring_dow&&w.val(n.recurring_dow.split(",")).trigger("change"));y.val(n.appointment_status_id).trigger("change")}(a.appointment),n.modal("show")})))}};function P(){i[0].reset(),i.parsley().reset(),i.find("select").trigger("change")}}(),appointmentList=function(){let e,t,n,a=$("#addAppointment"),i=$("#refreshAppointment"),r=$(".status-filter"),d=$(".category-filter"),o=$("#printTable"),l=$("#printList"),s=$("#calendar"),c=$("#appointmentsTablePrint"),m=$("#appointmentsTablePrintTitle"),p=c.find("tbody");return{init:function(){$("#appointmentNavigator").datepicker({todayHighlight:!0,todayBtn:!0}).on("changeDate",(function(e){u(e.date)})),$(".qn-week").click((function(){const e=parseInt(this.text);n.changeView("timeGridWeek"),n.incrementDate({weeks:e})})),$(".qn-month").click((function(){const e=parseInt(this.text);n.changeView("dayGridMonth"),n.incrementDate({months:e})})),e="all",t="all",_isCurrentBranchAll&&a.remove();s=document.getElementById("calendar"),n=new FullCalendar.Calendar(s,{schedulerLicenseKey:"CC-Attribution-NonCommercial-NoDerivatives",height:"100%",navLinks:!0,selectable:!0,selectMirror:!0,dayMaxEvents:!0,editable:!0,slotMinTime:"09:00:00",eventDrop:function(e){cms.confirm("Update Schedule","Are you sure you want to update this record?",(()=>{_id=e.event.id;const t={startDate:cms.convertToDateTime(e.event.start),endDate:cms.convertToDateTime(e.event.end)};cms.put(`${_url}/${_id}/update-schedule`,t,(()=>{toastr.success("Record has been updated.","Update Schedule"),appointmentList.reload()}))}),null,(()=>{e.revert()}))},themeSystem:"bootstrap5",initialView:"dayGridMonth",headerToolbar:{left:"prev,next today searchButton",center:"title",right:"timeGridDay,timeGridWeek,dayGridMonth,resourceTimeGridDay"},views:{resourceTimeGridDay:{buttonText:"categories"},timeGridWeek:{dayHeaderContent:e=>moment(e.date).format("ddd D/M")}},select:function(e){_id=0,appointmentForm.viewForm(e.start,e.end,null!=e.resource?e.resource.id:void 0)},resources:`${_rootUrl}/appointment-categories/calendar`,eventSources:[{display:"block",url:`${_url}/calendar`,extraParams:function(){return{status:e,category:t}}}],loading:function(e){setTimeout((()=>{e?loader.removeClass("loaded"):loader.addClass("loaded")}),0)},customButtons:{searchButton:{icon:"search",click:function(){appointmentSearch.viewSearch()}}},eventClick:function(e){_id=e.event.id,appointmentDetails.viewDetails()}}),n.render(),a.click((function(){_id=0,appointmentForm.viewForm()})),i.click((function(){f()})),r.click((function(t){t.stopPropagation();let n=$(this).find(".fa-check"),a=$("#sf"),i=n.attr("id").replace("sf","");n.toggleClass("hide"),""==i?n.hasClass("hide")?r.find(".fa-check").addClass("hide"):r.find(".fa-check").removeClass("hide"):n.hasClass("hide")&&a.addClass("hide"),e=a.is(":visible")?"all":r.find(".fa-check:visible").map((function(){return this.id.replace("sf","")})).get().join(","),"all"==e||""!=e&&r.not("#allStatusLink").length==e.split(",").length?a.removeClass("hide"):a.addClass("hide"),f()})),d.click((function(e){e.stopPropagation();let n=$(this).find(".fa-check"),a=$("#cf"),i=n.attr("id").replace("cf","");n.toggleClass("hide"),""==i?n.hasClass("hide")?d.find(".fa-check").addClass("hide"):d.find(".fa-check").removeClass("hide"):n.hasClass("hide")&&a.addClass("hide"),t=a.is(":visible")?"all":d.find(".fa-check:visible").map((function(){return this.id.replace("cf","")})).get().join(","),"all"==t||""!=t&&d.not("#allCategoryLink").length==t.split(",").length?a.removeClass("hide"):a.addClass("hide"),f()})),o.click((function(){c.removeClass("table-print"),window.print()})),l.click((function(){m.text(n.view.title),c.addClass("table-print");let e=[];const t=n.getEvents().filter((function(e){return e.start>=n.view.activeStart&&(null!=e.end?e.end:e.start)<=n.view.activeEnd})).sort((function(e,t){return e.start-t.start}));for(let n=0;n<t.length;n++){const a=t[n];e.push(`<tr>\n                            <td>${cms.formatDateTime(a.start)}</td>\n                            <td>${cms.formatDateTime(null!=a.end?a.end:a.start)}</td>\n                            <td>${a.extendedProps.patient}</td>\n                            <td>${a.extendedProps.guest}</td>\n                            <td>${a.extendedProps.category}</td>\n                            <td>${a.extendedProps.branch}</td>\n                            </tr>`)}p.html(e.join("")),c.print()}))},reload:f,viewDay:u,getPatientAppointment:function(e){const t=n.getEvents().filter((function(t){return t.extendedProps.patient_id==e&&cms.currentDate()==cms.formatDate(t.start)}));if(t.length>0)return t[0].start;return null}};function u(e){n.changeView("timeGridDay",e)}function f(){loader.removeClass("loaded"),n.refetchEvents(),loader.addClass("loaded")}}();$((function(){$(document).ready((function(){appointmentList.init(),appointmentForm.init(),appointmentDetails.init()}))}));
