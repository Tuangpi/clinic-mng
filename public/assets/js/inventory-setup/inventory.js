var itemDetails=function(){let e=$("#itemDetailsModal"),t=$("#itemDetailsModalTitle"),i=e.find("#photoPreview"),a=e.find("#itemId"),n=e.find("#code"),o=e.find("#name"),c=e.find("#type"),l=e.find("#category"),r=e.find("#uom"),d=e.find("#description"),s=e.find("#dosageContainer"),m=e.find("#usage"),u=e.find("#dosage"),p=e.find("#unit"),f=e.find("#frequency"),g=e.find("#totalDosage"),h=e.find("#sellingPriceDisplay"),v=e.find("#costPriceDisplay"),_=e.find("#supplier"),y=e.find("#manufacturer"),x=e.find("#criticalLevelDisplay"),w=e.find("#status"),b=e.find("#createdBy"),k=e.find("#createdDate"),D=e.find("#modifiedBy"),C=e.find("#modifiedDate");return{view:function(){cms.get(`${_url}/${_id}`,null,(function($){!function(e){t.text(`${e.code} - ${e.name}`),a.text(e.code),n.text(e.code2),o.text(e.name),c.text(e.product_type.description),l.text(e.product_category.description),r.text(e.uom.description),d.text(e.description),e.has_dosage?(m.text(cms.isNull(e.usage?.description,"")),u.text(cms.isNull(e.dosage?.description,"")),p.text(cms.isNull(e.dosage_uom?.description,"")),f.text(cms.isNull(e.frequency?.description,"")),g.text(cms.numberWithCommas(e.total_dosage)),s.show()):(m.text(""),u.text(""),p.text(""),f.text(""),g.text(""),s.hide());h.text(cms.numberWithCommas(e.selling_price)),v.text(cms.numberWithCommas(e.cost_price)),_.text(e.supplier.name),y.text(e.manufacturer.name),x.html(e.is_stock_unlimited?'<i class="fa fa-infinity"></i>':cms.numberWithCommas(e.critical_level)),w.text(e.is_active?"Active":"Inactive"),b.text(`${e.creator.first_name} ${e.creator.last_name}`),k.text(cms.formatDateTime(e.created_at)),D.text(`${e.updator.first_name} ${e.updator.last_name}`),C.text(cms.formatDateTime(e.updated_at)),null!=e.photo_ext&&i.attr("src",`/storage/product-image/${e.id}.${e.photo_ext}?v=${moment(e.updated_at).format("MMDDYYYYHHmmss")}`)}($.product),e.modal("show")}))}}}(),itemForm=function(){let e,t=$("#itemFormModal"),i=$("#itemFormModalTitle"),a=$("#itemForm"),n=a.find("#photoPreview"),o=a.find("#removePhoto"),c=a.find("#photo"),l=a.find("#photoImage"),r=new FileReader,d=$("#photoCamera"),s=$("#cameraModal"),m=$("#capture"),u=a.find("#itemId"),p=a.find("#code"),f=a.find("#name"),g=a.find("#type"),h=a.find("#category"),v=a.find("#uom"),_=a.find("#description"),y=a.find("#hasDosage"),x=a.find("#dosageContainer"),w=a.find(".dosage-fields"),b=a.find("#usage"),k=a.find("#dosage"),D=a.find("#unit"),C=a.find("#frequency"),P=a.find("#totalDosage"),S=a.find("#sellingPrice"),F=a.find("#costPrice"),q=a.find("#supplier"),T=a.find("#manufacturer"),I=a.find("#criticalLevel"),M=a.find("#status"),A=a.find("#unlimitedStock"),E=t.find("#saveItem");return{init:function(){g.select2({placeholder:"Select Type",dropdownParent:a}),h.select2({placeholder:"Select Category",dropdownParent:a}),v.select2({placeholder:"Select UOM",dropdownParent:a}),b.select2({placeholder:"Select Usage",dropdownParent:a}),k.select2({placeholder:"Select Dosage",dropdownParent:a}),D.select2({placeholder:"Select Unit",dropdownParent:a}),C.select2({placeholder:"Select Frequency",dropdownParent:a}),q.select2({placeholder:"Select Supplier",dropdownParent:a}),T.select2({placeholder:"Select Manufacturer",dropdownParent:a}),M.select2({placeholder:"Select Status",dropdownParent:a}),new AutoNumeric("#totalDosage",{minimumValue:0,watchExternalChanges:!0}),new AutoNumeric("#sellingPrice",{minimumValue:0,watchExternalChanges:!0}),new AutoNumeric("#costPrice",{minimumValue:0,watchExternalChanges:!0}),new AutoNumeric("#criticalLevel",{minimumValue:0,watchExternalChanges:!0}),l.click((e=>{e.stopPropagation(),c.click()})),c.on("change",(()=>{r.readAsDataURL(c.prop("files")[0])})),r.onloadend=e=>{n.attr("src",e.target.result),o.removeClass("hide")},o.click((function(){c.val(""),n.attr("src",_defaultPhotoSrc),o.addClass("hide")})),d.click((async function(){let e=document.querySelector("#video"),t=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});e.srcObject=t,s.modal("show")})),s.on("hidden.bs.modal",(function(){const e=document.querySelector("#video").srcObject.getTracks();e[0].stop(),e.forEach((e=>e.stop()))})),m.click((function(e){let t=document.querySelector("#canvas");t.getContext("2d").drawImage(video,0,0,t.width,t.height),n.attr("src",t.toDataURL("image/jpeg")),c.val(""),o.removeClass("hide")})),y.change((function(){$(this).is(":checked")?x.slideDown():x.slideUp()})),A.change((function(){const e=$(this).is(":checked");e&&I.val(0),I.prop("disabled",e)})),E.click((function(){!function(){if(a.parsley().validate()){let t={code:p.val(),name:f.val(),type:g.val(),category:h.val(),uom:v.val(),description:_.val(),sellingPrice:cms.convertToDecimal(S.val()),costPrice:cms.convertToDecimal(F.val()),hasDosage:y.is(":checked")?1:0,usage:b.val(),dosage:k.val(),unit:D.val(),frequency:C.val(),totalDosage:cms.convertToDecimal(P.val()),supplier:q.val(),manufacturer:T.val(),criticalLevel:cms.convertToDecimal(I.val()),status:M.val(),isStockUnlimited:A.is(":checked")?1:0,photoExt:e};n.attr("src")!=_defaultPhotoSrc?null!=r.result&&c.prop("files").length>0?(t.photo=r.result.split("base64,")[1],t.photoExt=c.prop("files")[0].name.split(".").pop()):n.attr("src").indexOf("base64")>=0&&(t.photo=n.attr("src").split("base64,")[1],t.photoExt="jpg"):t.photoExt=null,cms.saveForm(_id,t,_url,(function(){itemList.reload(),0==_id&&j()}))}}()})),t.on("hidden.bs.modal",(function(){j()}))},view:function(a){0==_id?(i.text("Create New Item"),g.val(a).trigger("change"),o.addClass("hide"),t.modal("show")):(i.text("Edit Item Details"),o.removeClass("hide"),cms.get(`${_url}/${_id}/edit`,null,(function(i){var a;a=i.product,u.val(a.code),p.val(a.code2),f.val(a.name),g.val(a.product_type_id).trigger("change"),h.val(a.product_category_id).trigger("change"),v.val(a.uom_id).trigger("change"),_.val(a.description),y.prop("checked",a.has_dosage).trigger("change"),b.val(a.usage_id).trigger("change"),k.val(a.dosage_id).trigger("change"),D.val(a.dosage_uom_id).trigger("change"),C.val(a.frequency_id).trigger("change"),P.val(a.total_dosage),S.val(a.selling_price),F.val(a.cost_price),q.val(a.supplier_id).trigger("change"),T.val(a.manufacturer_id).trigger("change"),I.val(a.critical_level),M.val(a.is_active).trigger("change"),A.prop("checked",a.is_stock_unlimited).trigger("change"),e=a.photo_ext,null!=a.photo_ext?n.attr("src",`/storage/product-image/${a.id}.${a.photo_ext}?v=${moment(a.updated_at).format("MMDDYYYYHHmmss")}`):o.addClass("hide"),t.modal("show")})))}};function j(){n.attr("src",_defaultPhotoSrc),x.hide(),w.prop("required",!1),a[0].reset(),a.parsley().reset(),a.find("select,#unlimitedStock").trigger("change")}}(),itemList=function(){let e,t=$("#addItem"),i=$(".add-item-type"),a=$("#itemsTable");return{init:function(){_isCurrentBranchAll&&t.remove();e=a.DataTable({processing:!0,serverSide:!0,ajax:_url,columns:[{data:null,name:"actions",searchable:!1,orderable:!1},{data:"code",name:"code"},{data:"name",name:"name"},{data:"current_stock",name:"current_stock",render:function(e){return cms.numberWithCommas(e)}},{data:"uom",name:"uom"},{data:"type",name:"type"},{data:"category",name:"category"},{data:"selling_price",name:"selling_price"},{data:"cost_price",name:"cost_price"},{data:"branch",name:"branch"}],order:[[2,"asc"]],createdRow:function(e,t,i){let a=$(e);a.find("td:eq(0)").addClass("text-center").html(`<div class="btn-group dropend">\n                        <a href="#" class="dropdown-toggle text-primary" data-bs-toggle="dropdown">\n                        <i class="fa fa-ellipsis-vertical"></i>\n                        </a>\n                        <ul class="dropdown-menu dropdown-menu-end">\n                            <li><button id="edit${t.id}" class="dropdown-item edit fs-11px" type="button">Edit</button></li>\n                            <li><button id="del${t.id}" class="dropdown-item delete fs-11px" type="button">Delete</button></li>\n                        </ul>\n                    </div>`),a.find("td:eq(1)").html(`<a href="javascript:;" id="view${t.id}" class='view'>${t.code}</a>`),t.is_active||a.addClass("fst-italic text-muted"),t.is_stock_unlimited?a.find("td:eq(3)").html('<i class="fa fa-infinity"></i>'):parseFloat(t.critical_level)>parseFloat(t.current_stock)&&a.find("td:eq(3)").addClass("text-danger"),a.find("td:eq(7)").html(`${t.currency_symbol}${cms.numberWithCommas(t.selling_price)}`),a.find("td:eq(8)").html(`${t.currency_symbol}${cms.numberWithCommas(t.cost_price)}`)},drawCallback:function(){a.find(".edit").unbind("click").click((function(){_id=this.id.replace("edit",""),itemForm.view()})),a.find(".delete").unbind("click").click((function(){cms.confirm("Delete Item","Are you sure you want to delete this record?",(()=>{cms.delete(`${_url}/${this.id.replace("del","")}`,null,(()=>{toastr.success("Item has been deleted.","Delete Item"),n()}))}))})),a.find(".view").unbind("click").click((function(){_id=this.id.replace("view",""),itemDetails.view()}))},initComplete:function(){$("#itemsTable_filter input").unbind(),$("#itemsTable_filter input").keyup((function(t){13==t.keyCode&&e.search(this.value).draw()}));const t=$("#itemsTable_filter"),i=$(`<select id="typeFilter" class="form-select form-select-sm d-inline-block w-auto ms-2">\n                <option value="">All Types</option>\n                ${$("#itemForm").find("#type").children().not(":eq(0)").map((function(){return`<option value="${this.value}">${this.text}</option>`})).get().join("")}\n                </select>`);t.append(i);const a=$(`<select id="categoryFilter" class="form-select form-select-sm d-inline-block w-auto ms-2">\n                <option value="">All Categories</option>\n                ${$("#itemForm").find("#category").children().not(":eq(0)").map((function(){return`<option value="${this.value}">${this.text}</option>`})).get().join("")}\n                </select>`);t.append(a);const n=$('<select id="criticalStatusFilter" class="form-select form-select-sm d-inline-block w-auto ms-2">\n                <option value="">All Quantity Status</option>\n                <option value="1">Critical</option>\n                <option value="0">Not Critical</option>\n                </select>');t.append(n),$("#typeFilter, #categoryFilter, #criticalStatusFilter").change((function(){e.ajax.url(`${_url}/?type=${i.val()}&category=${a.val()}&critical=${n.val()}`).load()}))}}),i.click((function(){_id=0,itemForm.view(this.id.replace("type",""))}))},reload:n};function n(){e.ajax.reload(null,!1)}}();$((function(){$(document).ready((function(){itemForm.init(),itemList.init()}))}));
