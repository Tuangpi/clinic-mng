var packageDetails=function(){let e=$("#packageDetailsModal"),t=$("#packageDetailsModalTitle"),n=e.find("#packageId"),i=e.find("#code"),a=e.find("#name"),c=e.find("#type"),o=e.find("#category"),d=e.find("#description"),r=e.find("#sessionCount"),l=e.find("#sellingPriceDisplay"),s=e.find("#costPrice"),u=e.find("#status"),p=e.find("#itemsTable").find("tbody"),m=e.find("#createdBy"),f=e.find("#createdDate"),g=e.find("#modifiedBy"),v=e.find("#modifiedDate");return{view:function(){cms.get(`${_url}/${_id}`,null,(function($){!function(e){t.text(`${e.code} - ${e.name}`),n.text(e.code),i.text(e.code2),a.text(e.name),c.text(e.product_type.description),o.text(e.product_category.description),d.text(e.description),r.text(e.session_count),l.text(cms.numberWithCommas(e.selling_price)),s.text(cms.numberWithCommas(e.cost_price)),u.text(e.is_active?"Active":"Inactive");let $=[];for(let t=0;t<e.package_products.length;t++){const n=e.package_products[t];$.push(`<tr>\n                <td>${n.product.name}</td>\n                <td>${null!=n.qty?cms.numberWithCommas(n.qty):"-"}</td>\n            </tr>`)}p.html($.join("")),m.text(`${e.creator.first_name} ${e.creator.last_name}`),f.text(cms.formatDateTime(e.created_at)),g.text(`${e.updator.first_name} ${e.updator.last_name}`),v.text(cms.formatDateTime(e.updated_at))}($.package),e.modal("show")}))}}}(),packageForm=function(){let e=$("#packageFormModal"),t=$("#packageFormModalTitle"),n=$("#packageForm"),i=n.find("#packageId"),a=n.find("#code"),c=n.find("#name"),o=n.find("#type"),d=n.find("#category"),r=n.find("#description"),l=n.find("#sellingPrice"),s=n.find("#costPrice"),u=n.find("#sessionCount"),p=n.find("#status"),m=e.find("#addItem"),f=e.find("#itemsTable"),g=f.find("tbody"),v=e.find("#savePackage"),h=0;return{init:function(){o.val(_defaultType),d.val(_defaultCategory),o.select2({placeholder:"Select Type",dropdownParent:n}),d.select2({placeholder:"Select Category",dropdownParent:n}),p.select2({placeholder:"Select Status",dropdownParent:n}),new AutoNumeric("#sellingPrice",{minimumValue:0,watchExternalChanges:!0}),new AutoNumeric("#sessionCount",{minimumValue:0,decimalPlaces:0,watchExternalChanges:!0}),m.click((function(){_({id:0,product_id:"",qty:""})})),v.click((function(){!function(){const e=g.children();f.find(".bg-red-100").removeClass("bg-red-100");let t=!1;if(e.each((function(n){const i=$(this);for(let a=n+1;a<e.length;a++){const n=$(e[a]);if(i.find(".product").val()==n.find(".product").val()){i.addClass("bg-red-100"),n.addClass("bg-red-100"),t=!0;break}}if(t)return!1})),t)return toastr.error("Unable to save package, duplicate items found."),!1;if(n.parsley().validate()){let e={code:a.val(),name:c.val(),type:o.val(),category:d.val(),description:r.val(),sessionCount:cms.convertToInt(u.val()),sellingPrice:cms.convertToDecimal(l.val()),status:p.val(),products:g.children().map((function(e,t){const n=$(t),i=n.find(".qty");return{id:this.id.replace("tr",""),product:n.find(".product").val(),qty:i.is(":visible")?cms.convertToDecimal(n.find(".qty").val()):null}})).get()};cms.saveForm(_id,e,_url,(function(){packageList.reload(),0==_id&&y()}))}}()})),e.on("hidden.bs.modal",(function(){y()}))},view:function(){0==_id?(t.text("Create New Package"),e.modal("show")):(t.text("Edit Package Details"),cms.get(`${_url}/${_id}/edit`,null,(function(t){!function(e){i.val(e.code),a.val(e.code2),c.val(e.name),o.val(e.product_type_id).trigger("change"),d.val(e.product_category_id).trigger("change"),r.val(e.description),u.val(e.session_count),l.val(e.selling_price),s.val(cms.numberWithCommas(e.cost_price)),p.val(e.is_active).trigger("change");for(let t=0;t<e.package_products.length;t++){_(e.package_products[t])}}(t.package),e.modal("show")})))}};function _(e){h++;const t=$(`\n        <tr id="tr${e.id}">\n        <td><button type="button" class="btn btn-primary btn-xs fs-9px delete"><i class="fa fa-trash"></i></button></td>\n        <td><select class="form-select form-select-sm product" required data-parsley-errors-container="#product-error${h}">\n        <option value="" disabled="true" ${""==e.product_id?"selected":""}>Select Item</option>\n        ${_products.filter((function(t){return t.is_active||!t.is_active&&t.id==e.product_id})).map((function(t){return`<option value="${t.id}" ${e.product_id==t.id?"selected":""} data-unli="${t.is_stock_unlimited?1:0}">${t.code} - ${t.name}</option>`})).join("")}\n        </select>\n        <div id="product-error${h}"></div>\n        </td>\n        <td>\n        <input id="qty${h}" type="text" class="qty form-control form-control-sm" value="${e.qty}" required/></td>\n        </tr>\n        `).appendTo(g);t.find(".delete").click((function(){$(this).closest("tr").remove()}));const i=t.find(`#qty${h}`);t.find(".product").select2({width:"100%",placeholder:"Select Item",dropdownParent:n}).change((function(){const e="1"==$(this).find("option:selected").data("unli");i.prop("required",!e),e?i.val("").hide():i.show()})).trigger("change"),new AutoNumeric(`#qty${h}`,{minimumValue:0,watchExternalChanges:!0})}function y(){g.html(""),n[0].reset(),n.parsley().reset(),o.val(_defaultType),d.val(_defaultCategory),n.find("select").trigger("change")}}(),packageList=function(){let e,t=$("#addPackage"),n=$("#packagesTable");return{init:function(){_isCurrentBranchAll&&t.remove();e=n.DataTable({processing:!0,serverSide:!0,ajax:_url,columns:[{data:null,name:"actions",searchable:!1,orderable:!1},{data:"code",name:"code"},{data:"name",name:"name"},{data:"type",name:"type"},{data:"category",name:"category"},{data:"session_count",name:"session_count",render:function(e){return cms.numberWithCommas(e)}},{data:"selling_price",name:"selling_price"},{data:"cost_price",name:"cost_price"},{data:"branch",name:"branch"}],order:[[2,"asc"]],createdRow:function(e,t,n){let i=$(e);i.find("td:eq(0)").addClass("text-center").html(`<div class="btn-group dropend">\n                        <a href="#" class="dropdown-toggle text-primary" data-bs-toggle="dropdown">\n                        <i class="fa fa-ellipsis-vertical"></i>\n                        </a>\n                        <ul class="dropdown-menu dropdown-menu-end">\n                            <li><button id="edit${t.id}" class="dropdown-item edit fs-11px" type="button">Edit</button></li>\n                            <li><button id="del${t.id}" class="dropdown-item delete fs-11px" type="button">Delete</button></li>\n                        </ul>\n                    </div>`),i.find("td:eq(1)").html(`<a href="javascript:;" id="view${t.id}" class='view'>${t.code}</a>`),i.find("td:eq(6)").html(`${t.currency_symbol}${cms.numberWithCommas(t.selling_price)}`),i.find("td:eq(7)").html(`${t.currency_symbol}${cms.numberWithCommas(t.cost_price)}`)},drawCallback:function(){n.find(".edit").unbind("click").click((function(){_id=this.id.replace("edit",""),packageForm.view()})),n.find(".delete").unbind("click").click((function(){cms.confirm("Delete Package","Are you sure you want to delete this record?",(()=>{cms.delete(`${_url}/${this.id.replace("del","")}`,null,(()=>{toastr.success("Package has been deleted.","Delete Package"),i()}))}))})),n.find(".view").unbind("click").click((function(){_id=this.id.replace("view",""),packageDetails.view()}))},initComplete:function(){$("#packagesTable_filter input").unbind(),$("#packagesTable_filter input").keyup((function(t){13==t.keyCode&&e.search(this.value).draw()}));const t=$("#packagesTable_filter"),n=$(`<select id="typeFilter" class="form-select form-select-sm d-inline-block w-auto ms-2">\n                <option value="">All Types</option>\n                ${$("#packageForm").find("#type").children().not(":eq(0)").map((function(){return`<option value="${this.value}">${this.text}</option>`})).get().join("")}\n                </select>`);t.append(n);const i=$(`<select id="categoryFilter" class="form-select form-select-sm d-inline-block w-auto ms-2">\n                <option value="">All Categories</option>\n                ${$("#packageForm").find("#category").children().not(":eq(0)").map((function(){return`<option value="${this.value}">${this.text}</option>`})).get().join("")}\n                </select>`);t.append(i),$("#typeFilter, #categoryFilter").change((function(){e.ajax.url(`${_url}/?type=${n.val()}&category=${i.val()}`).load()}))}}),t.click((function(){_id=0,packageForm.view()}))},reload:i};function i(){e.ajax.reload(null,!1)}}();$((function(){$(document).ready((function(){packageForm.init(),packageList.init()}))}));
