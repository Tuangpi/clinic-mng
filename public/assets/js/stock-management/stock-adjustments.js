var adjustmentDetails=function(){let t=$("#adjustmentDetailsModal"),e=$("#adjustmentDetailsModalTitle"),n=t.find("#adjustmentDate"),a=t.find("#type"),d=t.find("#branchContainer"),r=t.find("#branch"),i=t.find("#supplierContainer"),o=t.find("#supplier"),s=t.find("#itemsTable").find("tbody"),c=t.find("#createdBy"),l=t.find("#createdDate");return{view:function(){cms.get(`${_url}/${_id}`,null,(function(u){!function(t){e.text(t.code),n.text(cms.formatDate(t.adjustment_date)),a.text(t.stock_adjustment_type.description),2==t.stock_adjustment_type_id||3==t.stock_adjustment_type_id?(r.text(t.other_branch.description),o.text(""),d.show(),i.hide()):4==t.stock_adjustment_type_id?(r.text(""),o.text(t.supplier.name),d.hide(),i.show()):(d.hide(),i.hide());let u=[];for(let e=0;e<t.products.length;e++){const n=t.products[e];u.push(`<tr id="pop${n.id}">\n                <td class='item'>${n.product.code} - ${n.product.name}</td>\n                <td>${n.uom}</td>\n                <td>${cms.numberWithCommas(n.current_stock)}</td>\n                <td>${cms.numberWithCommas(n.qty)}</td>\n                <td>${cms.numberWithCommas(n.updated_stock)}</td>\n                <td>${cms.isNull(n.batch_no,"")}</td>\n                <td>${null!=cms.expiry_date?cms.formatDate(expiry_date):""}</td>\n                <td>${n.remarks}</td>\n            </tr>`)}s.html(u.join("")),c.text(`${t.creator.first_name} ${t.creator.last_name}`),l.text(cms.formatDateTime(t.created_at))}(u.adjustment),t.modal("show")}))}}}(),adjustmentForm=function(){let t=$("#adjustmentFormModal"),e=$("#adjustmentForm"),n=e.find("#adjustmentDate"),a=e.find("#type"),d=e.find("#qtyDescription"),r=e.find("#branchContainer"),i=e.find("#branch"),o=e.find("#supplierContainer"),s=e.find("#supplier"),c=e.find("#addItem"),l=t.find("#itemsTable"),u=l.find("tbody"),m=t.find("#saveAdjustment"),p=0;return{init:function(){n.datepicker({todayHighlight:!0}),a.select2({placeholder:"Select Type",dropdownParent:e}),i.select2({placeholder:"Select Branch",dropdownParent:e}),s.select2({placeholder:"Select Supplier",dropdownParent:e}),a.change((function(){2==this.value||4==this.value?(u.find(".qty-type").text("-").prop("disabled",!0),d.text("Qty value should be negative (-) only")):3==this.value?(u.find(".qty-type").text("+").prop("disabled",!0),d.text("Qty value should be positive (+) only")):(u.find(".qty-type").text("+").prop("disabled",!1),d.text("Qty value can be either positive or negative (+/-)")),2==this.value||3==this.value?(i.prop("required",!0),s.prop("required",!1),r.show(),o.hide()):4==this.value?(i.prop("required",!1),s.prop("required",!0),r.hide(),o.show()):(i.prop("required",!1),s.prop("required",!1),r.hide(),o.hide()),u.find(".qty").trigger("change")})),c.click((function(){!function(t){p++;let n="+",d=!1,r=a.val();2==r||4==r?(n="-",d=!0):3==r?(n="+",d=!0):(n="+",d=!1);const i=$(`\n        <tr id="tr${t.id}">\n        <td><button type="button" class="btn btn-primary btn-xs fs-9px delete"><i class="fa fa-trash"></i></button></td>\n        <td><select class="form-select form-select-sm product" required data-parsley-errors-container="#product-error${p}">\n        <option value="" disabled="true" ${""==t.product_id?"selected":""}>Select Item</option>\n        ${_products.filter((function(e){return e.is_active||!e.is_active&&e.id==t.product_id})).map((function(e){return`<option value="${e.id}" ${t.product_id==e.id?"selected":""} data-uom="${e.uom}" data-price="${e.cost_price}" data-cstock="${e.current_stock}">${e.code} - ${e.name}</option>`})).join("")}\n        </select>\n        <div id="product-error${p}"></div>\n        </td>\n        <td class="uom">${t.uom}</td>\n        <td>\n            <div class="input-group input-group-sm">\n                <button type="button" class="btn btn-primary qty-type" ${d?'disabled="true"':""}>${n}</button>\n                <input id="qty${p}" type="text" class="qty form-control form-control-sm" value="${t.qty}" required/>\n            </div>\n            <small>Current Stock: <span class="current-stock">${cms.numberWithCommas(cms.convertToDecimal(t.current_stock))}</span></small><br/>\n            <small>Updated Stock: <span class="updated-stock"></span></small>\n        </td>\n        <td><input type="text" class="bn form-control form-control-sm" placeholder="Batch No." value="${cms.isNull(t.batch_no,"")}"/></td>\n        <td>\n            <div class="input-group input-group-sm date">\n                <input type="text"\n                    class="form-control form-control-sm datepicker expiry-date"\n                    placeholder="DD/MM/YYYY" value="${null!=t.expiry_date?cms.formatDate(t.expiry_date):""}"/>\n                <span class="input-group-text input-group-addon bg-primary"><i\n                        class="fa fa-calendar"></i></span>\n            </div>\n        </td>\n        <td><input type="text" class="remarks form-control form-control-sm" placeholder="Remarks" value="${cms.isNull(t.remarks,"")}" required/></td>\n        </tr>\n        `).appendTo(u);i.find(".qty-type").click((function(){const t=$(this);"+"==t.text()?t.text("-"):t.text("+"),i.find(".qty").trigger("change")})),i.find(".qty").change((function(){let t;if(""!=this.value){let e=parseFloat(this.value);t="-"==i.find(".qty-type").text()?cms.convertToDecimal(i.find(".current-stock").text())-e:cms.convertToDecimal(i.find(".current-stock").text())+e}i.find(".updated-stock").text(cms.numberWithCommas(t))})),i.find(".delete").click((function(){$(this).closest("tr").remove()})),i.find(".product").select2({width:"100%",placeholder:"Select Item",dropdownParent:e}).change((function(){const t=$(this).find("option:selected");i.find(".uom").text(t.data("uom")),i.find(".current-stock").text(t.data("cstock"))})),new AutoNumeric(`#qty${p}`,{minimumValue:0,watchExternalChanges:!0}),i.find(".datepicker").datepicker({todayHighlight:!0})}({id:0,product_id:"",uom:"",current_stock:"",qty:"",updated_stock:"",batch_no:"",expiry_date:null,remarks:""})})),m.click((function(){!function(){const t=u.children();if(0==t.length)return toastr.error("Unable to save adjustment, no item found."),!1;{l.find(".bg-red-100").removeClass("bg-red-100");let e=!1;if(t.each((function(n){const a=$(this);for(let d=n+1;d<t.length;d++){const n=$(t[d]);if(a.find(".product").val()==n.find(".product").val()){a.addClass("bg-red-100"),n.addClass("bg-red-100"),e=!0;break}}if(e)return!1})),e)return toastr.error("Unable to save adjustment, duplicate items found."),!1}e.parsley().validate()&&cms.confirm("Create Adjustment","Adjustment is not editable and deletable, are you sure you want to create this record?",(()=>{let t={adjustmentDate:cms.convertToDate(n.val()),type:a.val(),branch:i.val(),supplier:s.val(),products:u.children().map((function(t,e){const n=$(e);return{id:this.id.replace("tr",""),product:n.find(".product").val(),uom:n.find(".uom").text(),qty:cms.convertToDecimal(("-"==n.find(".qty-type").text()?"-":"")+n.find(".qty").val()),bn:n.find(".bn").val(),expiryDate:cms.convertToDate(n.find(".expiry-date").val()),remarks:n.find(".remarks").val()}})).get()};cms.saveForm(_id,t,_url,(function(){adjustmentList.reload(),0==_id&&f()}))}))}()})),t.on("hidden.bs.modal",(function(){f()}))},view:function(){t.modal("show")}};function f(){u.html(""),e[0].reset(),e.parsley().reset(),e.find("select").trigger("change"),d.text("")}}(),adjustmentList=function(){let t,e=$("#addAdjustment"),n=$("#adjustmentsTable");return{init:function(){_isCurrentBranchAll&&e.remove();t=n.DataTable({processing:!0,serverSide:!0,ajax:_url,columns:[{data:"code",name:"code"},{data:"created_by",name:"created_by"},{data:"adjustment_date",name:"adjustment_date",render:function(t){return cms.formatDate(t)}},{data:"branch",name:"branch"}],order:[[1,"asc"]],createdRow:function(t,e,n){$(t).find("td:eq(0)").html(`<a href="javascript:;" id="view${e.id}" class='view'>${e.code}</a>`)},drawCallback:function(){n.find(".view").unbind("click").click((function(){_id=this.id.replace("view",""),adjustmentDetails.view()}))},initComplete:function(){$("#adjustmentsTable_filter input").unbind(),$("#adjustmentsTable_filter input").keyup((function(e){13==e.keyCode&&t.search(this.value).draw()}));const e=$("#adjustmentsTable_filter"),n=moment().startOf("year"),a=moment().endOf("year"),d=$(`<div id="drFilter" class="btn btn-white d-inline-block w-auto ms-2">\n                <span class="flex-1">${n.format("MMMM D, YYYY")} - ${a.format("MMMM D, YYYY")}</span>\n                <i class="fa fa-caret-down"></i>\n                </div>`);e.append(d),d.daterangepicker({startDate:n,endDate:a,showDropdowns:!0,ranges:{Today:[moment(),moment()],Yesterday:[moment().subtract(1,"days"),moment().subtract(1,"days")],"Last 7 Days":[moment().subtract(6,"days"),moment()],"Last 30 Days":[moment().subtract(29,"days"),moment()],"This Month":[moment().startOf("month"),moment().endOf("month")],"Last Month":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")],"This Year":[n,a]}},(function(e,n,a){d.find("span").html(e.format("MMMM D, YYYY")+" - "+n.format("MMMM D, YYYY")),t.ajax.url(`${_url}/?startDate=${e.format("YYYY-MM-DD")}&endDate=${n.format("YYYY-MM-DD")}`).load()}))}}),e.click((function(){_id=0,adjustmentForm.view()}))},reload:function(){t.ajax.reload(null,!1)}}}();$((function(){$(document).ready((function(){adjustmentForm.init(),adjustmentList.init()}))}));
