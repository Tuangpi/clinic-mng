var roleForm=function(){let e=$("#roleFormModal"),t=$("#roleFormModalTitle"),i=$("#roleForm"),n=i.find("#description"),a=i.find("#module"),o=e.find("#saveRole");return{init:function(){a.select2({placeholder:"Select Modules",dropdownParent:i,multiple:!0}),o.click((function(){!function(){if(i.parsley().validate()){let e={description:n.val(),module:a.val()};cms.saveForm(_id,e,_roleUrl,(function(e){roleList.reload(),0==_id&&l(),userForm.refreshRoleDropdown(e.roles)}))}}()})),e.on("hidden.bs.modal",(function(){l()}))},view:function(){0==_id?(t.text("Create New Role"),e.modal("show")):(t.text("Edit Role Details"),cms.get(`${_roleUrl}/${_id}/edit`,null,(function(t){var i;i=t.role,n.val(i.description),a.val(i.module_ids).trigger("change"),e.modal("show")})))}};function l(){i[0].reset(),i.parsley().reset(),i.find("select").trigger("change")}}(),roleList=function(){let e,t=$("#addRole"),i=$("#rolesTable");return{init:function(){null==e&&(e=i.DataTable({processing:!0,serverSide:!0,ajax:_roleUrl,columns:[{data:null,name:"actions",searchable:!1,orderable:!1},{data:"description",name:"description"}],order:[[1,"asc"]],createdRow:function(e,t,i){$(e).find("td:eq(0)").addClass("text-center").html(t.is_system_default?"":`<div class="btn-group dropend">\n                            <a href="#" class="dropdown-toggle text-primary" data-bs-toggle="dropdown">\n                            <i class="fa fa-ellipsis-vertical"></i>\n                            </a>\n                            <ul class="dropdown-menu dropdown-menu-end">\n                                <li><button id="edit${t.id}" class="dropdown-item edit fs-11px" type="button">Edit</button></li>\n                                <li><button id="del${t.id}" class="dropdown-item delete fs-11px" type="button">Delete</button></li>\n                            </ul>\n                        </div>`)},drawCallback:function(){i.find(".edit").unbind("click").click((function(){_id=this.id.replace("edit",""),roleForm.view()})),i.find(".delete").unbind("click").click((function(){cms.confirm("Delete Role","Are you sure you want to delete this record?",(()=>{cms.delete(`${_roleUrl}/${this.id.replace("del","")}`,null,(e=>{toastr.success("Role has been deleted.","Delete Role"),n(),userForm.refreshRoleDropdown(e.roles)}))}))}))},initComplete:function(){$("#rolesTable_filter input").unbind(),$("#rolesTable_filter input").keyup((function(t){13==t.keyCode&&e.search(this.value).draw()}))}})),t.click((function(){_id=0,roleForm.view()}))},reload:n};function n(){e.ajax.reload(null,!1)}}(),userDetails=function(){let e=$("#userDetailsModal"),t=$("#userDetailsModalTitle"),i=e.find("#photoPreview"),n=e.find("#userId"),a=e.find("#firstName"),o=e.find("#lastName"),l=e.find("#nationality"),r=e.find("#nric"),d=e.find("#mobileNo"),s=e.find("#email"),c=e.find("#status"),u=e.find("#role"),m=e.find("#branches");return{view:function(){cms.get(`${_userUrl}/${_id}`,null,(function(f){!function(e){t.text(`${e.code} - ${e.full_name}`),n.text(e.code),s.text(e.email),a.text(e.first_name),o.text(e.last_name),l.text(e.nationality?.description),r.text(e.nric),u.text(e.user_role?.description),d.text(e.mobile_number),c.text(e.is_active?"Active":"Inactive");let f=1==e.user_role_id?"All":e.branches.map((function(e){return e.description})).join(", ");m.text(f),null!=e.photo_ext?i.attr("src",`/storage/user-profile/${e.id}.${e.photo_ext}?v=${moment(e.updated_at).format("MMDDYYYYHHmmss")}`):i.attr("src",_defaultPhotoSrc)}(f.user),e.modal("show")}))}}}(),userForm=function(){let e,t=$("#userFormModal"),i=$("#userFormModalTitle"),n=$("#userForm"),a=$("#photoPreview"),o=$("#removePhoto"),l=$("#photo"),r=$("#photoImage"),d=new FileReader,s=$("#photoCamera"),c=$("#cameraModal"),u=$("#capture"),m=n.find("#firstName"),f=n.find("#lastName"),p=n.find("#username"),h=n.find("#passwordContainer"),v=n.find("#password"),b=n.find("#email"),_=n.find("#nationality"),w=n.find("#nric"),g=n.find("#mobileNo"),x=n.find("#role"),y=n.find("#status"),k=n.find("#branchContainer"),D=n.find("#branch"),C=t.find("#saveUser");return{init:function(){_.select2({placeholder:"Select Nationality",dropdownParent:n}),x.select2({placeholder:"Select Role",dropdownParent:n}),D.select2({placeholder:"Select Branches",dropdownParent:n,multiple:!0}),y.select2({placeholder:"Select Status",dropdownParent:n}),r.click((e=>{e.stopPropagation(),l.click()})),l.on("change",(()=>{d.readAsDataURL(l.prop("files")[0])})),d.onloadend=e=>{a.attr("src",e.target.result),o.removeClass("hide")},o.click((function(){l.val(""),a.attr("src",_defaultPhotoSrc),o.addClass("hide")})),s.click((async function(){let e=document.querySelector("#video"),t=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});e.srcObject=t,c.modal("show")})),c.on("hidden.bs.modal",(function(){const e=document.querySelector("#video").srcObject.getTracks();e[0].stop(),e.forEach((e=>e.stop()))})),u.click((function(e){let t=document.querySelector("#canvas");t.getContext("2d").drawImage(video,0,0,t.width,t.height),a.attr("src",t.toDataURL("image/jpeg")),l.val(""),o.removeClass("hide")})),$("#showPassword").click((function(){const e=$(this).find(".fa");e.hasClass("fa-eye")?v.attr("type","text"):v.attr("type","password"),e.toggleClass("fa-eye fa-eye-slash")})),x.change((function(){1==this.value?(D.val("").trigger("change"),k.hide()):k.show()})),C.click((function(){!function(){if(n.parsley().validate()){let t={firstName:m.val(),lastName:f.val(),username:p.val(),password:v.val(),email:b.val(),nationality:_.val(),nric:w.val(),mobileNo:g.val(),status:y.val(),role:x.val(),branch:D.val(),photoExt:e};a.attr("src")!=_defaultPhotoSrc?null!=d.result&&l.prop("files").length>0?(t.photo=d.result.split("base64,")[1],t.photoExt=l.prop("files")[0].name.split(".").pop()):a.attr("src").indexOf("base64")>=0&&(t.photo=a.attr("src").split("base64,")[1],t.photoExt="jpg"):t.photoExt=null,cms.saveForm(_id,t,_userUrl,(function(){userList.reload(),0==_id&&F()}))}}()})),t.on("hidden.bs.modal",(function(){F()}))},view:function(){v.prop("required",0==_id),0==_id?(i.text("Create New User"),h.show(),o.addClass("hide"),t.modal("show")):(i.text("Edit User Details"),h.hide(),o.removeClass("hide"),cms.get(`${_userUrl}/${_id}/edit`,null,(function(i){var n;n=i.user,m.val(n.first_name),f.val(n.last_name),p.val(n.username),b.val(n.email),_.val(n.nationality_id).trigger("change"),w.val(n.nric),g.val(n.mobile_number),y.val(n.is_active).trigger("change"),x.val(n.user_role_id).trigger("change"),D.val(n.branch_ids).trigger("change"),e=n.photo_ext,null!=n.photo_ext?a.attr("src",`/storage/user-profile/${n.id}.${n.photo_ext}?v=${moment(n.updated_at).format("MMDDYYYYHHmmss")}`):o.addClass("hide"),t.modal("show")})))},refreshRoleDropdown:function(e){x.html('<option value="" disabled selected></option>').select2({placeholder:"Select Role",dropdownParent:n,data:e})}};function F(){a.attr("src",_defaultPhotoSrc),n[0].reset(),n.parsley().reset(),n.find("select").trigger("change"),k.hide()}}(),userList=function(){let e,t=$("#addUser"),i=$("#usersTable");return{init:function(){e=i.DataTable({processing:!0,serverSide:!0,ajax:_userUrl,columns:[{data:null,name:"actions",searchable:!1,orderable:!1},{data:null,name:"image",searchable:!1,orderable:!1},{data:"code",name:"code"},{data:"username",name:"username"},{data:"name",name:"name"},{data:"email",name:"email"},{data:"mobile_number",name:"mobile_number"},{data:"role",name:"role"},{data:"is_active",name:"is_active",render:function(e){let t="Active",i="success";return 0==e&&(t="Inactive",i="danger"),`<span class="text-${i}">${t}</span>`}}],order:[[2,"asc"]],createdRow:function(e,t,i){let n=$(e);n.find("td:eq(0)").addClass("text-center").html(`<div class="btn-group dropend">\n                        <a href="#" class="dropdown-toggle text-primary" data-bs-toggle="dropdown">\n                        <i class="fa fa-ellipsis-vertical"></i>\n                        </a>\n                        <ul class="dropdown-menu dropdown-menu-end">\n                            <li><button id="edit${t.id}" class="dropdown-item edit fs-11px" type="button">Edit</button></li>\n                            <li><button id="del${t.id}" class="dropdown-item delete fs-11px" type="button">Delete</button></li>\n                        </ul>\n                    </div>`),n.find("td:eq(1)").addClass("text-center").html(`<img src="${null!=t.photo_ext?`/storage/user-profile/${t.id}.${t.photo_ext}?v=${moment(t.updated_at).format("MMDDYYYYHHmmss")}`:_defaultPhotoSrc}" class="rounded h-30px my-n1 mx-n1">`),n.find("td:eq(2)").html(`<a href="javascript:;" id="view${t.id}" class='view'>${t.code}</a>`)},drawCallback:function(){i.find(".edit").unbind("click").click((function(){_id=this.id.replace("edit",""),userForm.view()})),i.find(".delete").unbind("click").click((function(){cms.confirm("Delete User","Are you sure you want to delete this record?",(()=>{cms.delete(`${_userUrl}/${this.id.replace("del","")}`,null,(()=>{toastr.success("User has been deleted.","Delete User"),n()}))}))})),i.find(".view").unbind("click").click((function(){_id=this.id.replace("view",""),userDetails.view()}))},initComplete:function(){$("#usersTable_filter input").unbind(),$("#usersTable_filter input").keyup((function(t){13==t.keyCode&&e.search(this.value).draw()}))}}),t.click((function(){_id=0,userForm.view()}))},reload:n};function n(){e.ajax.reload(null,!1)}}();$((function(){$(document).ready((function(){$("#userRolesLink").click((function(){roleList.init()})),roleForm.init(),userList.init(),userForm.init()}))}));
